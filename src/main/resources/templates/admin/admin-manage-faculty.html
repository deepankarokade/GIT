<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="en">

<head th:replace="~{fragments/admin-fragments :: admin-head(title='Manage Professors List')}">
    <!-- Extra styles for this page -->
    <style>
        .notification {
            animation: slideIn 0.3s ease-out;
            transition: all 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-[#111318] dark:text-white transition-colors duration-200">
    <div class="flex h-screen overflow-hidden">

        <aside th:replace="~{fragments/admin-fragments :: sidebar(activeItem='professor')}"></aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-y-auto bg-background-light dark:bg-background-dark">
            <header th:replace="~{fragments/admin-fragments :: navbar}"></header>
            <div class="max-w-7xl mx-auto py-8 px-6 w-full">
                <!-- Page Heading -->
                <div class="flex flex-wrap justify-between items-end gap-4 mb-8">
                    <div class="flex flex-col gap-2">
                        <h2 class="text-[#111318] dark:text-white text-3xl font-bold tracking-tight">Manage
                            Professors</h2>
                        <p class="text-[#616f89] dark:text-gray-400 text-base font-normal">Oversee and
                            manage academic staff records across all departments.</p>
                    </div>
                    <button onclick="window.location.href='/admin/dashboard/professor/add'"
                        class="flex items-center justify-center gap-2 rounded-lg h-11 px-6 bg-primary text-white text-sm font-bold transition-transform hover:scale-[1.02] active:scale-95 shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined text-xl">add</span>
                        <span>Add New Professor</span>
                    </button>
                </div>
                <!-- Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div
                        class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-background-dark border border-[#dbdfe6] dark:border-gray-800 shadow-sm">
                        <p id="totalCount" class="text-[#111318] dark:text-white text-3xl font-bold leading-tight">0</p>
                        <div class="flex items-center gap-3">
                            <span
                                class="material-symbols-outlined text-primary bg-primary/10 p-2 rounded-lg">groups</span>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Professors
                            </p>
                        </div>
                    </div>
                    <div
                        class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-background-dark border border-[#dbdfe6] dark:border-gray-800 shadow-sm">
                        <p id="activeCount" class="text-[#111318] dark:text-white text-3xl font-bold leading-tight">0
                        </p>
                        <div class="flex items-center gap-3">
                            <span
                                class="material-symbols-outlined text-green-500 bg-green-500/10 p-2 rounded-lg">how_to_reg</span>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Active Accounts
                            </p>
                        </div>
                    </div>
                    <div
                        class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-background-dark border border-[#dbdfe6] dark:border-gray-800 shadow-sm">
                        <p id="departmentCount" class="text-[#111318] dark:text-white text-3xl font-bold leading-tight">
                            0</p>
                        <div class="flex items-center gap-3">
                            <span
                                class="material-symbols-outlined text-orange-500 bg-orange-500/10 p-2 rounded-lg">account_tree</span>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total
                                Departments</p>
                        </div>
                    </div>
                </div>
                <!-- Search and Filters -->
                <div
                    class="bg-white dark:bg-background-dark border border-[#dbdfe6] dark:border-gray-800 rounded-xl mb-6">
                    <div class="p-4 flex flex-col md:flex-row gap-4 items-center">
                        <div class="w-full md:flex-1">
                            <label class="relative flex w-full">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                                    <span class="material-symbols-outlined text-gray-400">search</span>
                                </div>
                                <input
                                    class="w-full h-12 rounded-lg border-none bg-background-light dark:bg-gray-800 pl-12 pr-4 text-[#111318] dark:text-white placeholder:text-[#616f89] focus:ring-2 focus:ring-primary transition-all"
                                    placeholder="Search by name, UID, department or course..." />
                            </label>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                            <select id="departmentFilter" onchange="applyFilters()"
                                class="h-12 shrink-0 rounded-lg bg-background-light dark:bg-gray-800 px-4 border border-transparent hover:border-gray-300 dark:hover:border-gray-700 text-sm font-medium transition-all focus:ring-2 focus:ring-primary">
                                <option value="">All Departments</option>
                                <!-- Courses loaded dynamically -->
                            </select>
                            <select id="statusFilter" onchange="applyFilters()"
                                class="h-12 shrink-0 rounded-lg bg-background-light dark:bg-gray-800 px-4 border border-transparent hover:border-gray-300 dark:hover:border-gray-700 text-sm font-medium transition-all focus:ring-2 focus:ring-primary">
                                <option value="">All Status</option>
                                <option value="ACTIVE">Active</option>
                                <option value="INACTIVE">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Professor Table -->
                <div
                    class="bg-white dark:bg-background-dark border border-[#dbdfe6] dark:border-gray-800 rounded-xl overflow-hidden shadow-sm">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-gray-50 dark:bg-gray-800/50 border-b border-[#dbdfe6] dark:border-gray-800">
                                    <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-gray-500">
                                        Professor Name</th>
                                    <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-gray-500">
                                        UID</th>
                                    <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-gray-500">
                                        Course</th>
                                    <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-gray-500">
                                        Subjects</th>
                                    <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-gray-500">
                                        Account Status</th>
                                    <th
                                        class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-gray-500 text-right">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                                <!-- Loading state - will be replaced by JavaScript -->
                                <tr>
                                    <td colspan="6" class="px-6 py-12 text-center">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary">
                                            </div>
                                            <p class="text-sm text-gray-500">Loading faculty data...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div id="paginationContainer"
                        class="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 flex items-center justify-between border-t border-[#dbdfe6] dark:border-gray-800">
                        <p class="text-sm text-gray-500">Showing <span id="showingFrom"
                                class="font-semibold text-gray-700 dark:text-gray-300">0</span> to <span id="showingTo"
                                class="font-semibold text-gray-700 dark:text-gray-300">0</span> of <span
                                id="totalRecords" class="font-semibold text-gray-700 dark:text-gray-300">0</span>
                            results
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div th:replace="~{fragments/admin-fragments :: scripts}"></div>

    <script th:inline="javascript">
        // API URLs - BASE_URL comes from /js/config.js
        const API_BASE_URL = BASE_URL + '/admin/faculty';
        const COURSE_API_URL = BASE_URL + '/admin/course';

        let allFaculties = [];
        let filteredFaculties = [];

        // Load courses for department filter dropdown
        async function loadCoursesForFilter() {
            const departmentFilter = document.getElementById('departmentFilter');
            if (!departmentFilter) return;

            try {
                const response = await fetch(COURSE_API_URL);
                if (!response.ok) throw new Error('Failed to fetch courses');

                const courses = await response.json();

                // Keep the "All Departments" option and add courses
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.courseName;
                    option.textContent = course.courseName;
                    departmentFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading courses for filter:', error);
            }
        }

        // Load courses on page load
        document.addEventListener('DOMContentLoaded', loadCoursesForFilter);

        // Fetch all faculties on page load
        document.addEventListener('DOMContentLoaded', function () {
            fetchAllFaculties();
        });

        // Fetch all faculties from API
        async function fetchAllFaculties() {
            try {
                const response = await fetch(API_BASE_URL);

                if (!response.ok) {
                    throw new Error('Failed to fetch faculty data');
                }

                allFaculties = await response.json();

                // Ensure activity field exists for each faculty
                allFaculties = allFaculties.map(faculty => {
                    // If activity is not present, default to ACTIVE
                    if (!faculty.activity) {
                        faculty.activity = 'ACTIVE';
                    }
                    return faculty;
                });

                console.log('Loaded faculties:', allFaculties); // Debug log
                filteredFaculties = [...allFaculties];

                renderFacultyTable(filteredFaculties);
                updateStats(filteredFaculties);

            } catch (error) {
                console.error('Error fetching faculties:', error);
                showError('Failed to load faculty data. Please refresh the page.');
            }
        }

        // Render faculty table
        function renderFacultyTable(faculties) {
            const tbody = document.querySelector('tbody');

            if (!faculties || faculties.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            <div class="flex flex-col items-center gap-3">
                                <span class="material-symbols-outlined text-5xl">person_off</span>
                                <p class="text-lg font-medium">No faculty members found</p>
                            </div>
                        </td>
                    </tr>
                `;
                updatePagination(0);
                return;
            }

            tbody.innerHTML = faculties.map(faculty => {
                const initials = getInitials(faculty.fullName);
                const avatarColor = getAvatarColor(faculty.fullName);

                // Activity status mapping
                const activity = faculty.activity || 'INACTIVE';
                let statusColor, statusBgColor, statusText;

                switch (activity) {
                    case 'ACTIVE':
                        statusColor = 'text-green-700 dark:text-green-400';
                        statusBgColor = 'bg-green-500';
                        statusText = 'Active';
                        break;
                    case 'INACTIVE':
                        statusColor = 'text-gray-700 dark:text-gray-400';
                        statusBgColor = 'bg-gray-400';
                        statusText = 'Inactive';
                        break;
                    case 'BLOCKED':
                        statusColor = 'text-orange-700 dark:text-orange-400';
                        statusBgColor = 'bg-orange-500';
                        statusText = 'Blocked';
                        break;
                    case 'DELETED':
                        statusColor = 'text-red-700 dark:text-red-400';
                        statusBgColor = 'bg-red-500';
                        statusText = 'Deleted';
                        break;
                    default:
                        statusColor = 'text-gray-700 dark:text-gray-400';
                        statusBgColor = 'bg-gray-400';
                        statusText = 'Unknown';
                }

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/40 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                ${faculty.photofilename ?
                        `<img src="${API_BASE_URL}/${faculty.username}/profile-picture" 
                                         alt="${faculty.fullName}" 
                                         class="size-10 rounded-full object-cover border-2 border-gray-200"
                                         onerror="this.onerror=null; this.outerHTML='<div class=\\'size-10 rounded-full ${avatarColor} flex items-center justify-center font-semibold\\'>${initials}</div>';"`
                        :
                        `<div class="size-10 rounded-full ${avatarColor} flex items-center justify-center font-semibold">${initials}</div>`
                    }
                                <div>
                                    <p class="text-sm font-semibold">${faculty.fullName}</p>
                                    <p class="text-xs text-gray-500">${faculty.email}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm font-mono text-gray-600 dark:text-gray-400">
                            ${faculty.username}
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                                ${faculty.department || 'Not Assigned'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-1 flex-wrap">
                                <span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded">
                                    ${faculty.subject || 'N/A'}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-1.5 ${statusColor}">
                                <div class="size-2 rounded-full ${statusBgColor}"></div>
                                <span class="text-sm font-medium">${statusText}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="editFaculty('${faculty.username}')" 
                                    class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg text-gray-500 transition-colors"
                                    title="Edit Faculty">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="deleteFaculty('${faculty.username}')" 
                                    class="p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg text-gray-500 hover:text-red-500 transition-colors"
                                    title="Delete Faculty">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updatePagination(faculties.length);
        }

        // Update statistics
        function updateStats(faculties) {
            const totalFaculties = faculties.length;
            const activeFaculties = faculties.filter(f => f.activity === 'ACTIVE').length;
            const departments = new Set(faculties.map(f => f.department).filter(d => d)).size;

            // Update stat cards using IDs
            document.getElementById('totalCount').textContent = totalFaculties;
            document.getElementById('activeCount').textContent = activeFaculties;
            document.getElementById('departmentCount').textContent = departments;
        }

        // Update pagination info
        function updatePagination(count) {
            document.getElementById('showingFrom').textContent = count > 0 ? '1' : '0';
            document.getElementById('showingTo').textContent = count;
            document.getElementById('totalRecords').textContent = count;
        }

        // Get initials from name
        function getInitials(name) {
            if (!name) return '??';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        // Get avatar color based on name
        function getAvatarColor(name) {
            const colors = [
                'bg-blue-100 dark:bg-blue-900/30 text-blue-600',
                'bg-green-100 dark:bg-green-900/30 text-green-600',
                'bg-orange-100 dark:bg-orange-900/30 text-orange-600',
                'bg-purple-100 dark:bg-purple-900/30 text-purple-600',
                'bg-teal-100 dark:bg-teal-900/30 text-teal-600',
                'bg-pink-100 dark:bg-pink-900/30 text-pink-600',
            ];
            const index = name ? name.charCodeAt(0) % colors.length : 0;
            return colors[index];
        }

        // Apply filters function (search, department, status)
        function applyFilters() {
            const searchInput = document.querySelector('input[placeholder*="Search"]');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const departmentFilter = document.getElementById('departmentFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredFaculties = allFaculties.filter(faculty => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    (faculty.fullName && faculty.fullName.toLowerCase().includes(searchTerm)) ||
                    (faculty.username && faculty.username.toLowerCase().includes(searchTerm)) ||
                    (faculty.email && faculty.email.toLowerCase().includes(searchTerm)) ||
                    (faculty.department && faculty.department.toLowerCase().includes(searchTerm)) ||
                    (faculty.subject && faculty.subject.toLowerCase().includes(searchTerm));

                // Department filter
                const matchesDepartment = !departmentFilter ||
                    (faculty.department && faculty.department.toLowerCase().includes(departmentFilter.toLowerCase()));

                // Status filter
                const matchesStatus = !statusFilter ||
                    (faculty.activity && faculty.activity === statusFilter);

                return matchesSearch && matchesDepartment && matchesStatus;
            });

            renderFacultyTable(filteredFaculties);
            updateStats(filteredFaculties);
        }

        // Search input listener
        const searchInput = document.querySelector('input[placeholder*="Search"]');
        if (searchInput) {
            searchInput.addEventListener('input', applyFilters);
        }

        // Edit faculty
        function editFaculty(username) {
            // Redirect to edit page with username
            window.location.href = `/admin/dashboard/professor/edit/${username}`;
        }

        // Delete faculty
        async function deleteFaculty(username) {
            if (!confirm(`Verify if the "Delete Account" button delete the account forever, which means deleting the account permanently and also removing all historical teaching data. Only after confirming.\n\nAre you sure you want to delete ${username}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/${username}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Faculty deleted successfully!', 'success');
                    // Refresh the faculty list
                    setTimeout(() => {
                        fetchAllFaculties();
                    }, 1000);
                } else {
                    const error = await response.text();
                    showNotification(error || 'Failed to delete faculty', 'error');
                }
            } catch (error) {
                console.error('Error deleting faculty:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 ${type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                    'bg-blue-500 text-white'
                }`;

            notification.innerHTML = `
                <span class="material-symbols-outlined">${type === 'success' ? 'check_circle' :
                    type === 'error' ? 'error' :
                        'info'
                }</span>
                <span class="font-medium">${message}</span>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-red-500">
                        <div class="flex flex-col items-center gap-3">
                            <span class="material-symbols-outlined text-5xl">error</span>
                            <p class="text-lg font-medium">${message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    </script>
</body>

</html>