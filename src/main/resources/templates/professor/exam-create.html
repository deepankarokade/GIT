<!DOCTYPE html>
<html class="light" lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<meta content="width=device-width, initial-scale=1.0" name="viewport" />
	<title th:text="${exam.id != null ? 'Update Exam' : 'Create Exam'}">Create Exam - ExamPortal</title>
	<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
	<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
	<script>
		tailwind.config = {
			darkMode: "class",
			theme: {
				extend: {
					colors: {
						"primary": "#135bec",
						"background-light": "#f6f6f8",
						"background-dark": "#101622",
					},
					fontFamily: { "display": ["Lexend", "sans-serif"] },
				},
			},
		}
	</script>
	<style>
		body { font-family: 'Lexend', sans-serif; }
		.geometric-bg {
			background-color: #f6f6f8;
			background-image: radial-gradient(#135bec11 1px, transparent 1px);
			background-size: 24px 24px;
		}
		.dark .geometric-bg {
			background-color: #101622;
			background-image: radial-gradient(#135bec22 1px, transparent 1px);
		}
		.form-input-animated:focus {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(19, 91, 236, 0.15);
		}
	</style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#111318] dark:text-white antialiased">
	<div class="flex h-screen overflow-hidden">
		<aside class="w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col justify-between py-6">
			<div class="flex flex-col gap-8 px-6">
				<div class="flex gap-3 items-center">
					<div class="rounded-full size-12 border-2 border-primary overflow-hidden bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
						<img th:src="@{'/professor/photo/' + ${facultyId}}" alt="Profile" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
						<span class="material-symbols-outlined text-primary text-2xl hidden">person</span>
					</div>
					<div class="flex flex-col">
						<h1 class="text-[#111318] dark:text-white text-base font-semibold leading-tight" th:text="${professorName}">Professor</h1>
						<h5 class="text-slate-500 dark:text-slate-400 text-sm font-normal leading-tight">Faculty</h5>
					</div>
				</div>

				<nav class="flex flex-col gap-1">
					<a class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all" href="/professor/dashboard">
						<span class="material-symbols-outlined">dashboard</span>
						<p class="text-sm font-medium">Dashboard</p>
					</a>
					<a class="flex items-center gap-3 px-4 py-3 rounded-xl bg-primary text-white shadow-lg shadow-primary/20 transition-all" href="#">
						<span class="material-symbols-outlined fill-1">add_circle</span>
						<p class="text-sm font-medium">Create Exam</p>
					</a>
					<a class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all" href="/professor/exams">
						<span class="material-symbols-outlined">quiz</span>
						<p class="text-sm font-medium">My Exams</p>
					</a>
				</nav>
			</div>

			<div class="flex flex-col gap-1 px-6">
				<button id="darkModeToggle" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all">
					<span class="material-symbols-outlined">dark_mode</span>
					<p class="text-sm font-medium">Dark Mode</p>
					<div class="ml-auto">
						<div class="relative inline-block w-10 h-5 rounded-full bg-gray-300 dark:bg-primary transition-colors">
							<div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform dark:transform dark:translate-x-5"></div>
						</div>
					</div>
				</button>
				<a class="flex items-center gap-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all" href="/professor/login">
					<span class="material-symbols-outlined">logout</span>
					<p class="text-sm font-medium">Logout</p>
				</a>
			</div>
		</aside>

		<main class="flex-1 flex flex-col overflow-y-auto geometric-bg">
			<header class="flex items-center justify-between sticky top-0 z-10 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-8 py-4">
				<div class="flex items-center gap-2">
					<div class="text-primary"><span class="material-symbols-outlined text-3xl">school</span></div>
					<h2 class="text-slate-900 dark:text-white text-xl font-bold tracking-tight">Professor Portal</h2>
				</div>
				<a href="/professor/dashboard" class="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-primary transition-colors">
					<span class="material-symbols-outlined">arrow_back</span>
					<span class="text-sm font-medium">Back to Dashboard</span>
				</a>
			</header>

			<div class="p-8 max-w-[900px] mx-auto w-full flex flex-col gap-8">
				<section>
					<div class="flex items-center gap-4 mb-2">
						<div class="size-12 rounded-xl bg-primary/10 flex items-center justify-center text-primary">
							<span class="material-symbols-outlined text-2xl" th:text="${exam.id != null ? 'edit_note' : 'note_add'}">note_add</span>
						</div>
						<div>
							<h3 class="text-slate-900 dark:text-white text-2xl font-bold" th:text="${exam.id != null ? 'Update Exam' : 'Create New Exam'}">Create New Exam</h3>
							<p class="text-slate-500 dark:text-slate-400 text-sm">Fill in the details below to schedule a new examination.</p>
						</div>
					</div>
				</section>

				<section class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
					<form id="examForm" th:object="${exam}" class="p-8">
						<input type="hidden" id="examId" th:field="*{id}">

						<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
							<div class="md:col-span-2">
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Professor Name</label>
								<input type="text" th:field="*{professorName}" readonly
									class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800/50 text-slate-500 cursor-not-allowed">
							</div>
							
							<div>
							    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Exam Title</label>
							    <input type="text" th:field="*{title}" required placeholder="e.g. Java Programming"
							        class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all">
							</div>

							<div>
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Course Name</label>
								<select id="courseDropdown" th:field="*{courseName}" required onchange="handleCourseChange()"
									class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all cursor-pointer">
									<option value="">-- Loading Courses --</option>
								</select>
							</div>

							<!--<div>
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Subject (Exam Title)</label>
								<select id="subjectDropdown" th:field="*{title}" required 
									class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all cursor-pointer">
									<option value="">-- Select Course First --</option>
								</select>
							</div>-->

							<!--<div>
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Batch</label>
								<select id="batchDropdown" th:field="*{batch}" required class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all cursor-pointer">
									<option value="">-- Loading Batches --</option>
								</select>
							</div>-->

							<div>
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Exam Type</label>
								<select id="examTypeDropdown" th:field="*{examType}" required 
									class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all cursor-pointer">
									<option value="">-- Select Course First --</option>
								</select>
							</div>

							<div>
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Exam Date</label>
								<input type="date" id="examDate" th:field="*{examDate}" required class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all cursor-pointer">
							</div>

							<div class="grid grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Start Time</label>
									<input type="time" th:field="*{startTime}" required class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all">
								</div>
								<div>
									<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">End Time</label>
									<input type="time" th:field="*{endTime}" required class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all">
								</div>
							</div>

							<div>
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Venue Type</label>
								<select th:field="*{examVenueType}" required class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all cursor-pointer">
									<option value="ONLINE">Online</option>
									<option value="OFFLINE">Offline</option>
								</select>
							</div>

							<div>
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Duration (min)</label>
								<input type="number" th:field="*{duration}" required min="10" placeholder="Min 10 mins" class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all">
							</div>

							<div>
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Total Marks</label>
								<input type="number" th:field="*{totalMarks}" required min="1" placeholder="Total Marks" class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all">
							</div>

							<div class="md:col-span-2">
								<label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Additional Information</label>
								<textarea th:field="*{additionalInformation}" rows="3" placeholder="Special instructions (Max 250 chars)" maxlength="250" class="form-input-animated w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white transition-all resize-none"></textarea>
							</div>

							<div class="md:col-span-2">
								<div class="flex items-center justify-between p-4 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700">
									<div class="flex items-center gap-3">
										<span class="material-symbols-outlined text-primary">visibility</span>
										<div>
											<p class="text-sm font-semibold">Enable Exam Visibility</p>
											<p class="text-xs text-slate-500">Enable this to allow students to see the exam.</p>
										</div>
									</div>
									<label class="relative inline-flex items-center cursor-pointer">
										<input type="checkbox" th:field="*{enabled}" class="sr-only peer">
										<div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
									</label>
								</div>
							</div>
						</div>

						<div class="flex flex-col sm:flex-row gap-4 mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
							<button type="submit" class="flex-1 flex items-center justify-center gap-2 px-6 py-4 bg-primary hover:bg-blue-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-primary/25 hover:-translate-y-0.5">
								<span class="material-symbols-outlined" th:text="${exam.id != null ? 'save' : 'add_circle'}">add_circle</span>
								<span th:text="${exam.id != null ? 'Update Exam' : 'Create Exam'}">Create Exam</span>
							</button>
							<a href="/professor/dashboard" class="flex items-center justify-center gap-2 px-6 py-4 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-xl font-bold transition-all border border-slate-200 dark:border-slate-800">
								<span>Cancel</span>
							</a>
						</div>
					</form>
				</section>
			</div>
		</main>
	</div>

	<script th:inline="javascript">
		// Dark Mode
		(function initDarkMode() {
			const darkMode = localStorage.getItem('darkMode');
			if (darkMode === 'enabled') document.documentElement.classList.add('dark');
		})();

		// Thymeleaf Variables for Edit Mode
		const existingCourse = /*[[${exam.courseName}]]*/ '';
		const existingTitle = /*[[${exam.title}]]*/ '';
		const existingType = /*[[${exam.examType}]]*/ '';
		const existingBatch = /*[[${exam.batch}]]*/ '';

		document.addEventListener('DOMContentLoaded', () => {
			fetchInitialData();

			const darkModeToggle = document.getElementById('darkModeToggle');
			darkModeToggle.addEventListener('click', () => {
				document.documentElement.classList.toggle('dark');
				localStorage.setItem('darkMode', document.documentElement.classList.contains('dark') ? 'enabled' : 'disabled');
			});

			const dateInput = document.getElementById("examDate");
			if (dateInput && !dateInput.value) {
				dateInput.setAttribute("min", new Date().toISOString().split("T")[0]);
			}
		});

		async function fetchInitialData() {
			try {
				const [coursesRes, batchesRes] = await Promise.all([
					fetch('/professor/exams/api/courses'),
					fetch('/admin/api/batches')
				]);

				const courses = await coursesRes.json();
				const batches = await batchesRes.json();

				const courseDropdown = document.getElementById('courseDropdown');
				const batchDropdown = document.getElementById('batchDropdown');

				courseDropdown.innerHTML = '<option value="">-- Select Course --</option>';
				courses.forEach(c => {
					// Store ID in data-id for handleCourseChange
					courseDropdown.innerHTML += `<option value="${c.courseName}" data-id="${c.id}">${c.courseName}</option>`;
				});

				batchDropdown.innerHTML = '<option value="">-- Select Batch --</option>';
				batches.forEach(b => {
					batchDropdown.innerHTML += `<option value="${b.batchName}">${b.batchName}</option>`;
				});

				// Edit Mode
				if (existingCourse) {
					courseDropdown.value = existingCourse;
					await handleCourseChange();
				}
				if (existingBatch) {
					batchDropdown.value = existingBatch;
				}

			} catch (err) {
				console.error("Fetch error:", err);
			}
		}

		async function handleCourseChange() {
			const courseDropdown = document.getElementById('courseDropdown');
			const selectedOption = courseDropdown.options[courseDropdown.selectedIndex];
			const courseId = selectedOption.getAttribute('data-id');

			if (!courseId) {
				resetDependentDropdowns();
				return;
			}

			try {
				// Fetch subjects AND exam types using the new ID-based endpoint
				// Assuming your controller endpoint /api/course-details/{courseId}
				const response = await fetch('/professor/exams/api/course-details/' + courseId);
				const data = await response.json();

				const subjectDropdown = document.getElementById('subjectDropdown');
				const typeDropdown = document.getElementById('examTypeDropdown');

				// Update Subjects (Using existing logic or assuming data contains subjects)
				// If subjects aren't in this API, you might need a separate call or update controller
				if(data.subjects) {
					subjectDropdown.innerHTML = '<option value="">-- Select Subject --</option>';
					data.subjects.forEach(s => {
						const selected = (s.subjectName === existingTitle) ? 'selected' : '';
						subjectDropdown.innerHTML += `<option value="${s.subjectName}" ${selected}>${s.subjectName}</option>`;
					});
				}

				// Update Exam Types (Admin Defined)
				typeDropdown.innerHTML = '<option value="">-- Select Exam Type --</option>';
				data.examTypes.forEach(t => {
					const selected = (t.examName === existingType) ? 'selected' : '';
					typeDropdown.innerHTML += `<option value="${t.examName}" ${selected}>${t.examName}</option>`;
				});

			} catch (err) {
				console.error("Error loading course details:", err);
			}
		}

		function resetDependentDropdowns() {
			document.getElementById('subjectDropdown').innerHTML = '<option value="">-- Select Course First --</option>';
			document.getElementById('examTypeDropdown').innerHTML = '<option value="">-- Select Course First --</option>';
		}

		document.getElementById("examForm").addEventListener("submit", function (e) {
			e.preventDefault();

			const startTime = this.querySelector("[name='startTime']").value;
			const endTime = this.querySelector("[name='endTime']").value;

			if (endTime <= startTime) {
				showToast("End time must be after start time", "error");
				return;
			}

			const submitBtn = this.querySelector('button[type="submit"]');
			const originalText = submitBtn.innerHTML;
			submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span><span>Saving...</span>';
			submitBtn.disabled = true;

			// Construct JSON manually to ensure correct types
			const formData = new FormData(this);
			const examData = Object.fromEntries(formData.entries());
			examData.enabled = document.querySelector("[name='enabled']").checked;
			
			// Fix for optional ID
			if(!examData.id) delete examData.id;

			fetch("/professor/exams/save", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(examData)
			})
			.then(res => {
				if (!res.ok) return res.text().then(text => { throw new Error(text) });
				return res.text();
			})
			.then(response => {
				showToast("Exam Saved Successfully!", "success");
				setTimeout(() => {
					// If response is a number (ID), it's a new exam -> go to rules
					const isNew = !isNaN(response);
					window.location.href = isNew ? "/professor/exam-rule?examId=" + response : "/professor/exams";
				}, 1500);
			})
			.catch(err => {
				showToast(err.message || "Error saving exam", "error");
				submitBtn.innerHTML = originalText;
				submitBtn.disabled = false;
			});
		});

		function showToast(message, type = "info") {
			const toast = document.createElement('div');
			const bgColor = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
			toast.className = `fixed bottom-6 right-6 ${bgColor} text-white px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 z-50 transform transition-all duration-300`;
			toast.innerHTML = `<span class="material-symbols-outlined">${type === 'success' ? 'check_circle' : 'error'}</span><span class="font-medium">${message}</span>`;
			document.body.appendChild(toast);
			setTimeout(() => {
				toast.style.opacity = '0';
				setTimeout(() => toast.remove(), 300);
			}, 3000);
		}
	</script>
</body>
</html>